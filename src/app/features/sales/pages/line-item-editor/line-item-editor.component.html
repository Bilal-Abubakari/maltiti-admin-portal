@let product = selectedProduct();
<div class="line-item-editor">
  <div class="editor-header">
    <h4>Line Item</h4>
    <app-button
      icon="pi pi-trash"
      pTooltip="Remove Line Item"
      severity="danger"
      size="small"
      tooltipPosition="top"
      [outlined]="true"
      (click)="onRemove()"
    />
  </div>

  <form class="line-item-form" [formGroup]="lineItemForm">
    <!-- Product Selection -->
    <div class="form-row product-selection">
      <div class="form-field">
        <app-select
          id="product"
          label="Product *"
          [control]="lineItemForm.controls.productId"
          [options]="productOptions"
          [placeholder]="'Select a product'"
          [showClear]="true"
          [styleClass]="'product-select'"
        />
      </div>
      <div class="form-field price-type-selector-wrapper">
        <label for="price-type">Price Type</label>
        <div class="price-type-selector">
          <div class="radio-group">
            <div class="radio-option">
              <p-radioButton
                inputId="wholesale"
                value="wholesale"
                [formControl]="lineItemForm.controls.priceType"
              />
              <label class="radio-label" for="wholesale">
                Wholesale
                @if (product) {
                  <span class="price-value">{{ product.wholesale | currency: 'GH₵ ' }}</span>
                }
              </label>
            </div>
            <div class="radio-option">
              <p-radioButton
                inputId="retail"
                value="retail"
                [formControl]="lineItemForm.controls.priceType"
              />
              <label class="radio-label" for="retail">
                Retail
                @if (product) {
                  <span class="price-value">{{ product.retail | currency: 'GH₵ ' }}</span>
                }
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quantity and Price -->
    <div class="form-row">
      <div>
        <div class="form-field">
          <app-number-input
            id="quantity"
            label="Quantity *"
            [control]="lineItemForm.controls.requestedQuantity"
            [min]="1"
          />
          @if (lineItemForm.get('requestedQuantity')?.hasError('batchOverAllocated')) {
            <p-message severity="error" size="small" variant="simple">
              Batch allocation ({{ totalAllocatedQuantity() }}) exceeds requested quantity ({{ lineItemForm.get('requestedQuantity')?.value || 0 }})
            </p-message>
          } @else if (lineItemForm.get('requestedQuantity')?.hasError('batchAllocationMismatch')) {
            <p-message severity="error" size="small" variant="simple">
              Batch allocations must equal requested quantity
            </p-message>
          }
        </div>
      </div>

      <div class="form-field">
        <app-number-input
          id="price"
          label="Custom Price (Optional)"
          placeholder="Override with custom price"
          [control]="lineItemForm.controls.customPrice"
          [min]="0"
          [mode]="'currency'"
          [style]="{'width': '100%'}"
        />
        <small class="helper-text">Leave empty to use {{ priceType }} price</small>
      </div>

      <div class="form-field">
        <div class="total-price">
          <span>Total</span>
          <span>{{ getTotalPrice() | currency: 'GH₵ ' }}</span>
        </div>
      </div>
    </div>

    <!-- Batch Allocations -->
    @if (product && (isBatchRequired() || (lineItem()?.batchAllocations?.length ?? 0) > 0)) {
      <div class="batch-section">
        <div class="batch-header">
          <h5>Batch Allocations {{ isBatchRequired() ? '*' : '' }}</h5>
          <app-button
            icon="pi pi-plus"
            label="Add Batch"
            severity="info"
            size="small"
            [outlined]="true"
            (click)="addBatchAllocation()"
          />
        </div>

        <div class="batch-allocations">
          @if (batchControls().size === 0) {
            <div class="empty-batches">
              <p>No batches allocated yet.</p>
              @if (isBatchRequired()) {
                <small class="required-note">Batch allocation is required for this sale status.</small>
              }
            </div>
          } @else {
            @for (_ of this.batchControls().keys() || []; track $index; let i = $index) {
              @let batchId = getBatchControl(i).value;
              @let batchInfo = batchId ? getBatchInfo(batchId) : null;
              <div class="batch-allocation">
                <app-select
                  id="batch-{{i}}"
                  [control]="batchControls().get(i)!"
                  [options]="batchOptions()"
                  [placeholder]="'Select batch'"
                  [showClear]="true"
                  [styleClass]="'batch-select'"
                />

                <app-number-input
                  id="quantity-{{i}}"
                  [control]="getQuantityControl(i)"
                  [min]="1"
                  [style]="{'width': '30%'}"
                />

                @if (batchInfo) {
                  <div class="batch-info">
                    <small class="batch-details">
                      Available: {{ batchInfo.availableQuantity }}
                      @if (batchInfo.expiryDate) {
                        | Expires: {{ batchInfo.expiryDate | date }}
                      }
                    </small>
                  </div>
                }

                <app-button
                  icon="pi pi-minus"
                  severity="danger"
                  size="small"
                  [outlined]="true"
                  (click)="removeBatchAllocation(i)"
                />
              </div>
            }
          }
        </div>

        @if (isBatchRequired()) {
          <div class="allocation-summary">
            <small>
              Allocated: {{ totalAllocatedQuantity() }} / {{ lineItemForm.get('requestedQuantity')?.value || 0 }}
              @if (totalAllocatedQuantity() < (lineItemForm.get('requestedQuantity')?.value || 0)) {
                ({{ (lineItemForm.get('requestedQuantity')?.value || 0) - totalAllocatedQuantity() }} remaining)
              } @else if (totalAllocatedQuantity() > (lineItemForm.get('requestedQuantity')?.value || 0)) {
                ({{ totalAllocatedQuantity() - (lineItemForm.get('requestedQuantity')?.value || 0) }} over-allocated)
              }
            </small>
          </div>
        }
      </div>
    }
  </form>
</div>
